# -*- coding: utf-8 -*-
"""Class_Variances_ESC50.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1L41YFOE6ECroiTKoCbm5MuJGeXiJgJGz
"""

import pandas as pd
import csv
import librosa
import librosa.display
import numpy as np
import requests

"""Load the data"""

# Define the URL of the CSV file
csv_url = 'https://github.com/karolpiczak/ESC-50/raw/master/meta/esc50.csv'

# Read the CSV file from the provided URL
df = pd.read_csv(csv_url)


#df = pd.read_csv(csv_url, error_bad_lines=False)
#dog_df = df[df['category'] == 'dog']

# Print the first 5 rows of the DataFrame
#print(dog_df.head())

from io import BytesIO

def load_audio_data(row):
    # Construct the raw content URL for the audio file
    audio_file_url = f'https://github.com/karolpiczak/ESC-50/raw/master/audio/{row["filename"]}'

    # Download the audio file
    response = requests.get(audio_file_url)

    if response.status_code == 200:
        # Create a BytesIO object from the response content
        audio_data = BytesIO(response.content)

        # Load the audio from the BytesIO object
        y, sr = librosa.load(audio_data, sr=None)
        return y, sr

"""Comprehensive matrix"""

from concurrent.futures import ThreadPoolExecutor

def comprehensive_matrix(df):
    # Define the number of MFCC features you want
    n_mfcc = 13

    # Initialize empty list to store feature vectors
    features = []

    # Function to extract features from a single row
    def extract_features(row):
        y, sr = load_audio_data(row[1])
        mfcc = librosa.feature.mfcc(y=y, n_mfcc=n_mfcc, sr=sr)
        mfcc_mean = np.mean(mfcc, axis=1)
        mfcc_variance = np.var(mfcc, axis=1)
        mfcc_delta = librosa.feature.delta(mfcc)
        delta_mean = np.mean(mfcc_delta, axis=1)
        mfcc_delta_delta = librosa.feature.delta(mfcc, order=2)
        delta_delta_mean = np.mean(mfcc_delta_delta, axis=1)
        feature_vector = np.concatenate((mfcc_mean, mfcc_variance, delta_mean, delta_delta_mean))
        return feature_vector

    # Use ThreadPoolExecutor for parallel processing
    with ThreadPoolExecutor(max_workers=6) as executor:
        features = list(executor.map(extract_features, df.iterrows()))

    # Convert the list of feature vectors to a feature matrix
    comprehensive_matrix = np.array(features)

    return comprehensive_matrix


# Call the function
comprehensive_matrix = comprehensive_matrix(df)

# Print the matrix
print("Comprehensive Matrix:")
print(comprehensive_matrix)


print(comprehensive_matrix.shape)

"""PCA"""

!pip install scikit-learn
from sklearn.decomposition import PCA


def pca(comprehensive_matrix, num_components=None):

    # Initialize PCA
    pca = PCA(n_components=num_components,whiten = True)

    # Fit the PCA model to the data and transform the data
    reduced_features = pca.fit_transform(comprehensive_matrix)

    return reduced_features


# Call the function to run PCA on comprehensive matrix
reduced_matrix = pca(comprehensive_matrix, num_components=None)
#reduced_matrix = pca(comprehensive_matrix, num_components=24)

# Print the matrix
print("Reduced Matrix:")
print(reduced_matrix)

reduced_matrix.shape

"""scree plot to extract the num of components"""

import matplotlib.pyplot as plt


def scree_plot(reduced_matrix, num_components=None):

    # Perform PCA
    pca = PCA()
    pca.fit(reduced_matrix)

    # Calculate eigenvalues
    eigenvalues = pca.explained_variance_

    if num_components is not None:
        eigenvalues = eigenvalues[:num_components]

    # Plot the scree plot
    plt.plot(range(1, len(eigenvalues) + 1), eigenvalues, marker='o', linestyle='-')
    plt.xlabel('Principal Component Number')
    plt.ylabel('Eigenvalue')
    plt.title('Scree Plot')
    plt.grid()
    plt.show()


# To plot all components:
scree_plot(reduced_matrix)

"""class variances"""

def class_variance(df, reduced_matrix, class_names):

    if not isinstance(class_names, list):
        class_names = [class_names]

    class_variances = []

    for class_name in class_names:
        class_indices = [i for i, label in enumerate(df["category"]) if label == class_name]
        class_variance = np.var(reduced_matrix[class_indices], axis=1)
        class_variances.append(class_variance)

    combined_variances = np.concatenate(class_variances, axis=0)

    #print to check
    #print(combined_variances)

    total_variance = np.mean(combined_variances)

    return total_variance

#N_components=24 from the scree plot
reduced_matrix = pca(comprehensive_matrix, num_components=24)
class_name = ["dog", "rain"]
result = class_variance(df, reduced_matrix, class_name)
print(result)

"""check the result for individual class or two classes combine"""

class_name = "train"
result = class_variance(df, reduced_matrix, class_name)
print(f"total variance for class/es '{class_name}': {result}")

class_name = "wind"
result = class_variance(df, reduced_matrix, class_name)
print(f"total variance for class/es '{class_name}': {result}")

class_name = ["wind", "train"]
result = class_variance(df, reduced_matrix, class_name)
print(f"total variance for class/es '{class_name}': {result}")

class_name = "rain"
result = class_variance(df, reduced_matrix, class_name)
print(f"total variance for class/es '{class_name}': {result}")

class_name = "thunderstorm"
result = class_variance(df, reduced_matrix, class_name)
print(f"total variance for class/es '{class_name}': {result}")

class_name = ["rain", "thunderstorm"]
result = class_variance(df, reduced_matrix, class_name)
print(f"total variance for class/es '{class_name}': {result}")

class_name = "coughing"
result = class_variance(df, reduced_matrix, class_name)
print(f"total variance for class/es '{class_name}': {result}")

class_name = "airplane"
result = class_variance(df, reduced_matrix, class_name)
print(f"total variance for class/es '{class_name}': {result}")

class_name = ["airplane", "coughing"]
result = class_variance(df, reduced_matrix, class_name)
print(f"total variance for class/es '{class_name}': {result}")

class_name = "keyboard_typing"
result = class_variance(df, reduced_matrix, class_name)
print(f"total variance for class/es '{class_name}': {result}")

class_name = "cow"
result = class_variance(df, reduced_matrix, class_name)
print(f"total variance for class/es '{class_name}': {result}")

class_name = ["cow", "keyboard_typing"]
result = class_variance(df, reduced_matrix, class_name)
print(f"total variance for class/es '{class_name}': {result}")

class_name = "laughing"
result = class_variance(df, reduced_matrix, class_name)
print(f"total variance for class/es '{class_name}': {result}")

class_name = "clock_tick"
result = class_variance(df, reduced_matrix, class_name)
print(f"total variance for class/es '{class_name}': {result}")

class_name = ["laughing", "clock_tick"]
result = class_variance(df, reduced_matrix, class_name)
print(f"total variance for class/es '{class_name}': {result}")

class_name = ["wind", "train"]
result = class_variance(df, reduced_matrix, class_name)
print(f"total variance for class/es '{class_name}': {result}")

class_name = ["wind", "train", "thunderstorm"]
result = class_variance(df, reduced_matrix, class_name)
print(f"total variance for class/es '{class_name}': {result}")